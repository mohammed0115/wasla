{% extends "layouts/dashboard_base.html" %}
{% load i18n %}

{% block title %}{% trans "AI Tools" %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-1">{% trans "AI tools" %}</h1>
    <div class="text-muted small">{% trans "Generate descriptions, suggest categories, and explore visual search." %}</div>
  </div>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-white fw-bold">{% trans "Product description" %}</div>
      <div class="card-body">
        {% if products %}
          <form method="post" action="{% url 'web:dashboard_ai_description' 0 %}" data-ai-action="description">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">{% trans "Product" %}</label>
              <select class="form-select" name="product_id" required>
                {% for product in products %}
                  <option value="{{ product.id }}">{{ product.name }} ({{ product.sku }})</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">{% trans "Language" %}</label>
              <select class="form-select" name="language">
                <option value="ar">{% trans "Arabic" %}</option>
                <option value="en">{% trans "English" %}</option>
              </select>
            </div>
            <button class="btn btn-primary" type="submit">{% trans "Generate preview" %}</button>
          </form>
        {% else %}
          <div class="text-muted">{% trans "No products available yet." %}</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-white fw-bold">{% trans "Product category" %}</div>
      <div class="card-body">
        {% if products %}
          <form method="post" action="{% url 'web:dashboard_ai_categorize' 0 %}" data-ai-action="categorize">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">{% trans "Product" %}</label>
              <select class="form-select" name="product_id" required>
                {% for product in products %}
                  <option value="{{ product.id }}" {% if selected_product and selected_product.id == product.id %}selected{% endif %}>
                    {{ product.name }} ({{ product.sku }})
                  </option>
                {% endfor %}
              </select>
            </div>
            <button class="btn btn-outline-primary" type="submit">{% trans "Suggest category" %}</button>
          </form>
        {% else %}
          <div class="text-muted">{% trans "No products available yet." %}</div>
        {% endif %}

        {% if category_result and category_result.category_name %}
          <div class="alert alert-info mt-3">
            <div class="fw-bold">{% trans "Suggested category" %}</div>
            <div>{{ category_result.category_name }} ({{ category_result.confidence }})</div>
            {% if category_result.fallback_reason %}
              <div class="small text-muted">{% trans "Fallback used" %}</div>
            {% endif %}
          </div>
          {% if category_result.category_id %}
            <form method="post" action="{% url 'web:dashboard_ai_categorize' selected_product.id %}">
              {% csrf_token %}
              <input type="hidden" name="action" value="apply" />
              <input type="hidden" name="category_id" value="{{ category_result.category_id }}" />
              <button class="btn btn-success" type="submit">{% trans "Apply category" %}</button>
            </form>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mt-4">
  <div class="card-body d-flex justify-content-between align-items-center">
    <div>
      <div class="fw-bold">{% trans "Visual search" %}</div>
      <div class="text-muted small">{% trans "Upload an image to find similar products." %}</div>
    </div>
    <a class="btn btn-outline-secondary" href="{% url 'web:dashboard_ai_visual_search' %}">
      {% trans "Open visual search" %}
    </a>
  </div>
</div>

<script>
  document.querySelectorAll("form[data-ai-action]").forEach(function(form){
    form.addEventListener("submit", function(event){
      const productId = form.querySelector("select[name='product_id']").value;
      const action = form.getAttribute("data-ai-action");
      if (productId && action === "description") {
        form.action = "{% url 'web:dashboard_ai_description' 1 %}".replace("/1", "/" + productId);
      }
      if (productId && action === "categorize") {
        form.action = "{% url 'web:dashboard_ai_categorize' 1 %}".replace("/1", "/" + productId);
      }
    });
  });
</script>
{% endblock %}
